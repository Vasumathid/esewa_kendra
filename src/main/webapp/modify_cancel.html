<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Modify/Cancel Registration</title>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        .loading-spinner {
            display: none;
        }
    </style>
</head>

<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="box">
            <h1 class="display-4 title">Modify/Cancel Registration</h1>
            <hr class="my-4" />
        </div>
        <div class="mt-4">
            <label for="token">Enter Token Number:</label>
            <input type="text" id="token" name="token" required class="form-control">
            <div id="responseMessage" class="mt-3"></div>
            <div class="mt-4">
                <button type="button" id="modifyButton" class="btn btn-primary btn-lg button-spacing">Modify</button>
            </div>
            <form id="generateTokenForm" method="post" action="CancelBookingServlet">
                <button type="submit" class="btn btn-danger btn-lg button-spacing">Cancel Booking</button>
            </form>
            <div class="loading-spinner mt-2">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div class="container mt-5" id="esewa">

                <form id="registrationForm">
                    <div class="form-row mb-3">
                        <div class="col-md-3">
                            <label for="state" class="required">State:</label>
                            <select name="state" id="state" class="form-control">
                                <option value="">Select State</option>
                            </select>
                        </div>
                        <br />
                        <div class="col-md-3">
                            <label for="district" class="required">District:</label>
                            <select name="district" id="district" class="form-control">
                                <option value="">Select District</option>
                            </select>
                        </div>
                        <br />
                        <div class="col-md-3">
                            <label for="courtComplex" class="required">Court Complex:</label>
                            <select name="courtComplex" id="courtComplex" class="form-control">
                                <option value="">Select Court Complex</option>
                            </select>
                        </div>
                        <br />
                        <div class="col-md-3">
                            <label for="kendra" class="required">SewaKendra:</label>
                            <select name="kendra" id="kendra" class="form-control">
                                <option value="">Select E-Sewa Kendra</option>
                            </select>
                        </div>
                    </div>
                    <br />
                    <div class="form-row mb-3">
                        <div class="col-md-4">
                            <label for="serviceType" class="required">Service Type:</label>
                        </div>
                        <div class="col-md-8">
                            <select name="serviceType" id="serviceType" class="form-control"
                                onchange="loadServiceForm(this.value)">
                                <option value="">Select Type of Service</option>
                            </select>
                        </div>
                    </div>
                    <br />
                    <div class="form-row mb-3">
                        <div class="col-md-4">
                            <label for="advocateName" class="required">Name</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" name="advocateName" id="advocateName" class="form-control"
                                placeholder="Enter Name" required />
                        </div>
                    </div>
                    <br />

                    <div class="form-row mb-3">
                        <div class="col-md-4">
                            <label for="advocateOrParty">Advocate/Party in person</label>
                        </div>
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="radio" name="advocateOrParty" id="advocate" value="advocate"
                                            class="form-check-input">
                                        <label for="advocate" class="form-check-label">Advocate</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input type="radio" name="advocateOrParty" id="party" value="party"
                                            class="form-check-input">
                                        <label for="party" class="form-check-label">Party in person</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />
                    <div id="advocateDetails" style="display: none;">
                        <div class="form-row mb-3">
                            <div class="col-md-4">
                                <label for="enrollmentNumber">Enrollment Number: [MS/XXXX/YYYY]</label>
                            </div>
                            <div class="col-md-8">
                                <input type="text" name="enrollmentNumber" id="enrollmentNumber" class="form-control"
                                    placeholder="State Code/Bar Code/Bar Year">
                            </div>
                        </div>
                        <br />
                    </div>
                    <div class="form-row mb-3">
                        <div class="col-md-4">
                            <label for="phoneNumber" class="required">Phone Number:</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" name="phoneNumber" id="phoneNumber" class="form-control"
                                placeholder="Enter 10 digit Phone number" required />
                            <button type="button" class="btn btn-primary" id="sendOtpButton">Send OTP</button>
                            <div class="form-group" id="otpSection" style="display: none;">
                                <label for="otp">Enter OTP:</label>
                                <input type="text" class="form-control" id="otp" name="otp" required>
                                <button type="button" class="btn btn-success" id="verifyOtpButton">Verify OTP</button>
                            </div>
                        </div>
                    </div>
                    <br />
                    <div class="form-row mb-3">
                        <div class="col-md-4">
                            <label for="email" class="required">Email:</label>
                        </div>
                        <div class="col-md-8">
                            <input type="email" name="email" id="email" placeholder="Enter Email id"
                                class="form-control" required />
                        </div>
                    </div>
                    <br />
                    <div id="serviceFormContainer">
                        <!-- Dynamic service-specific form will be loaded here -->
                    </div>
                    <div id="message"></div>
                    <div id="registrationMessage" class="mt-4"></div>
                    <div id="error-message">
                        <span id="error-text"></span>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Token</button>
                </form>
            </div>
        </div>
    </div>
    <div id="footer-placeholder"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function () {
            function populateForm(data) {
                $('#state').val(data.bookingDetails.stateId).change(); // Trigger change to load districts
                setTimeout(function () {
                    $('#district').val(data.bookingDetails.districtId).change(); // Trigger change to load court complexes
                }, 500); // Adjust timeout as needed
                setTimeout(function () {
                    $('#courtComplex').val(data.bookingDetails.courtComplexId).change(); // Trigger change to load e-Sewa Kendras
                }, 1000);
                setTimeout(function () {
                    $('#kendra').val(data.bookingDetails.kendraId).change(); // Load e-Sewa Kendras
                }, 1500);

                $('#serviceType').val(data.bookingDetails.serviceTypeId).change(); // Load the specific service form

                setTimeout(function () {
                    $('#advocateName').val(data.bookingDetails.advocateName);
                    $('#enrollmentNumber').val(data.bookingDetails.enrollmentNumber);
                    $('#phoneNumber').val(data.bookingDetails.phoneNumber);
                    $('#email').val(data.bookingDetails.email);

                    // Handle radio buttons for advocate/party
                    if (data.bookingDetails.isAdvocate) {
                        $('#advocate').prop('checked', true);
                        $('#advocateDetails').show();
                    } else {
                        $('#party').prop('checked', true);
                    }// Populate other fields similarly...
                }, 2000);
            }
            $('#esewa').hide();
            $(document).ready(function () {
                // Fetch the booking details if a token_number is provided
                const urlParams = new URLSearchParams(window.location.search);
                const tokenNumber = urlParams.get('token_number');

                if (tokenNumber) {
                    $.getJSON('b ', { tokenNumber: tokenNumber }, function (data) {
                        populateForm(data);
                    }).fail(function () {
                        alert('Failed to load booking details.');
                    });
                }
            });
            $('#modifyButton').on('click', function () {
                var tokenNumber = $('#token').val().trim();
                if (tokenNumber) {
                    // Show loading spinner and disable button
                    $('.loading-spinner').show();
                    $('#modifyButton').prop('disabled', true);

                    // Fetch data based on token number
                    $.ajax({
                        type: 'GET',
                        url: 'GetBookingDetailsServlet', // Update this URL to your servlet endpoint
                        data: { token: tokenNumber },
                        dataType: 'json',
                        success: function (response) {
                            if (response.status === 'success') {
                                // Populate the form with the response data
                                $('#esewa').show();
                                populateForm(response.data);
                            } else {
                                $('#responseMessage').html(`<div class="alert alert-danger" role="alert">${response.message}</div>`);
                            }
                        },
                        error: function () {
                            $('#responseMessage').html('<div class="alert alert-danger" role="alert">An unexpected error occurred. Please try again later.</div>');
                        },
                        complete: function () {
                            // Hide loading spinner and enable button
                            $('.loading-spinner').hide();
                            $('#modifyButton').prop('disabled', false);
                        }
                    });
                } else {
                    $('#responseMessage').html('<div class="alert alert-warning" role="alert">Please enter a token number.</div>');
                }
            });

            function loadHTML(url, elementId) {
                fetch(url)
                    .then((response) => response.text())
                    .then((data) => {
                        document.getElementById(elementId).innerHTML = data;
                    });
            }
            function loadServiceForm(serviceId) {
                $(".loading-overlay").show();
                fetch(`getServices?serviceId=${serviceId}`)
                    .then((response) => response.text())
                    .then((html) => {
                        document.getElementById("serviceFormContainer").innerHTML = html;
                        $(".loading-overlay").hide();
                    });
                flatpickr("#date", {
                    minDate: "today",
                    maxDate: new Date().fp_incr(1),
                });
            }
            $("#serviceType").change(function () {
                var serviceId = $(this).val();
                if (serviceId) {
                    showLoadingOverlay();
                    fetch(`getServices?serviceId=${serviceId}`)
                        .then((response) => response.text())
                        .then((html) => {
                            document.getElementById("serviceFormContainer").innerHTML =
                                html;
                            $("#date, #time_slot").change(function () {
                                checkAvailability();
                            });

                            flatpickr(".date-Picker", {
                                minDate: "today",
                                maxDate: "today",
                                defaultDate: "today"
                            });
                            // Check if #case_type element exists and bind the change event
                            if ($('#case_type').length != 0) {
                                $('div#civil_or_criminal,div#cnr_number').hide();
                                $('#case_type').change(function () {
                                    handleCaseTypeChange($(this).val());
                                });
                            }
                        })
                        .catch((error) =>
                            console.error("Error loading service form:", error)
                        )
                        .finally(() => hideLoadingOverlay());
                } else {
                    $("#serviceFormContainer").empty();
                }
            });

            loadHTML("header.html", "header-placeholder");
            loadHTML("footer.html", "footer-placeholder");

            $('#generateTokenForm').on('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission

                var $form = $(this);
                var formData = $form.serialize(); // Serialize form data

                // Show loading spinner and disable buttons
                $('.loading-spinner').show();
                $('#generateTokenForm button').prop('disabled', true);

                $.ajax({
                    type: 'POST',
                    url: $form.attr('action'),
                    data: formData,
                    dataType: 'json',
                    success: function (response) {
                        var messageClass = response.status === 'success' ? 'alert-success' : 'alert-danger';
                        var message = response.message;

                        $('#responseMessage').html(`<div class="alert ${messageClass}" role="alert">${message}</div>`);
                    },
                    error: function (xhr, status, error) {
                        $('#responseMessage').html('<div class="alert alert-danger" role="alert">An unexpected error occurred. Please try again later.</div>');
                    },
                    complete: function () {
                        // Hide loading spinner and enable buttons
                        $('.loading-spinner').hide();
                        $('#generateTokenForm button').prop('disabled', false);
                    }
                });
            });
        });
    </script>
</body>

</html>