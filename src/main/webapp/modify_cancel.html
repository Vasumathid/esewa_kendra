<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Modify/Cancel Registration</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <!-- <script src="js/scripts.js"></script> -->
    <!-- <link rel="stylesheet" href="css/styles.css" /> -->
    <style>
        /* .loading-spinner {
            display: none;
        } */

        .mt-4.d-flex.align-items-center {
            display: flex;
        }

        .form-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
            /* Space between elements */
        }

        .form-container.modify-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .form-container>* {
            flex: 1;
        }

        @media (max-width: 576px) {
            .form-container {
                flex-direction: column;
                align-items: stretch;
            }

            .form-container>* {
                flex: none;
                width: 100%;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            z-index: 9999;
            display: none;
            /* Hidden by default */
            display: flex;
            /* Ensure the spinner is centered */
            align-items: center;
            /* Vertically center */
            justify-content: center;
            /* Horizontally center */
        }

        .loading-overlay .spinner {
            font-size: 2rem;
            /* Adjust size as needed */
            animation: zoom 1.5s ease-in-out infinite;
            /* Apply zoom animation */
        }
    </style>
</head>

<body>
    <div id="header-placeholder"></div>
    <div class="container">
        <div class="loading-overlay">
            <div class="spinner">
                <i class="fa fa-spinner fa-spin"></i>
            </div>
        </div>
        <div class="box">
            <h1 class="display-4 title">Modify/Cancel Registration</h1>
            <hr class="my-4" />
        </div>
        <div class="container mt-4">
            <div class="form-container modify-container">
                <label for="token">Enter Token Number:</label>
                <input type="text" id="token" name="token" required class="form-control">
                <button type="button" id="modifyButton" class="btn btn-primary btn-lg">Modify</button>
                <form id="generateTokenForm" method="post" action="CancelBookingServlet">
                    <button type="submit" class="btn btn-danger btn-lg">Cancel Booking</button>
                </form>
            </div>
        </div>

        <div class="container mt-5" id="esewa">
            <hr />
            <form id="registrationForm" method="post" action="modifyBooking">
                <div class="form-row mb-3">
                    <div class="col-md-3">
                        <label for="state" class="required">State:</label>
                        <select name="state" id="state" class="form-control">
                            <option value="">Select State</option>
                        </select>
                    </div>
                    <br />
                    <input type="hidden" name="tokenNumber" id="tokenNumber" />
                    <input type="hidden" name="bookingId" id="bookingId" />
                    <div class="col-md-3">
                        <label for="district" class="required">District:</label>
                        <select name="district" id="district" class="form-control">
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <br />
                    <div class="col-md-3">
                        <label for="courtComplex" class="required">Court Complex:</label>
                        <select name="courtComplex" id="courtComplex" class="form-control">
                            <option value="">Select Court Complex</option>
                        </select>
                    </div>
                    <br />
                    <div class="col-md-3">
                        <label for="kendra" class="required">SewaKendra:</label>
                        <select name="kendra" id="kendra" class="form-control">
                            <option value="">Select E-Sewa Kendra</option>
                        </select>
                    </div>
                </div>
                <br />
                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="serviceType" class="required">Service Type:</label>
                    </div>
                    <div class="col-md-8">
                        <select name="serviceType" id="serviceType" class="form-control">
                            <option value="">Select Type of Service</option>
                        </select>
                    </div>
                </div>
                <br />
                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="advocateName" class="required">Name</label>
                    </div>
                    <div class="col-md-8">
                        <input type="text" name="advocateName" id="advocateName" class="form-control"
                            placeholder="Enter Name" required disabled />
                    </div>
                </div>
                <br />

                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="advocateOrParty">Advocate/Party in person</label>
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="radio" name="advocateOrParty" id="advocate" value="advocate"
                                        class="form-check-input" disabled>
                                    <label for="advocate" class="form-check-label">Advocate</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input type="radio" name="advocateOrParty" id="party" value="party"
                                        class="form-check-input" disabled>
                                    <label for="party" class="form-check-label">Party in person</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br />
                <div id="advocateDetails" style="display: none;">
                    <div class="form-row mb-3">
                        <div class="col-md-4">
                            <label for="enrollmentNumber">Enrollment Number: [MS/XXXX/YYYY]</label>
                        </div>
                        <div class="col-md-8">
                            <input type="text" name="enrollmentNumber" id="enrollmentNumber" class="form-control"
                                placeholder="State Code/Bar Code/Bar Year" disabled>
                        </div>
                    </div>
                    <br />
                </div>
                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="phoneNumber" class="required">Phone Number:</label>
                    </div>
                    <div class="col-md-8">
                        <input type="text" name="phoneNumber" id="phoneNumber" class="form-control"
                            placeholder="Enter 10 digit Phone number" required disabled />
                    </div>
                </div>
                <br />
                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="email" class="required">Email:</label>
                    </div>
                    <div class="col-md-8">
                        <input type="email" name="email" id="email" placeholder="Enter Email id" class="form-control"
                            required disabled />
                    </div>
                </div>
                <br />
                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="date" class="required">Date:</label>
                    </div>
                    <div class="col-md-8">
                        <input type="date" name="date" id="date" class="form-control" placeholder="Select Date"
                            required />
                    </div>
                </div>
                <br />
                <div class="form-row mb-3">
                    <div class="col-md-4">
                        <label for="time_slot" class="required">Time Slot:</label>
                    </div>
                    <div class="col-md-8">
                        <select name="time_slot" id="time_slot" class="form-control" required>
                            <option value="">Select Time Slot</option>
                            <option value="forenoon">Forenoon</option>
                            <option value="afternoon">Afternoon</option>
                        </select>
                    </div>
                </div>
                <br />

                <div id="serviceFormContainer">
                    <!-- Dynamic service-specific form will be loaded here -->
                </div>
                <div id="message"></div>
                <div id="registrationMessage" class="mt-4"></div>
                <div id="error-message">
                    <span id="error-text"></span>
                </div>
                <button type="submit" class="btn btn-primary">Update Details</button>
            </form>
        </div>
    </div>
    </div>
    <div id="footer-placeholder"></div>
    <script>
        $(document).ready(function () {
            $('#date').flatpickr({
                dateFormat: "m/d/Y", // Set the format to mm/dd/yyyy
            });
            function showLoadingOverlay() {
                $(".loading-overlay").show();
            }

            function hideLoadingOverlay() {
                $(".loading-overlay").hide();
            }

            function loadStates() {
                // Load states
                $.get("dynamicForm", { action: "states" }, function (data) {
                    $("#state").html(data);
                }).always(function () {
                    hideLoadingOverlay();
                });
            }
            loadStates();
            function loadServiceType() {
                // Load service types on page load
                $.get("dynamicForm", { action: "serviceTypes" }, function (data) {
                    $("#serviceType").html(data);
                }).always(function () {
                    hideLoadingOverlay();
                });
            }
            loadServiceType();
            function loadDistricts(stateId) {
                showLoadingOverlay();
                return $.get("dynamicForm", { action: "districts", id: stateId }).always(function () {
                    hideLoadingOverlay();
                });
            }

            function loadCourtComplexes(districtId) {
                showLoadingOverlay();
                return $.get("dynamicForm", { action: "courtComplexes", id: districtId }).always(function () {
                    hideLoadingOverlay();
                });
            }

            $('#registrationForm').on('submit', function (event) {
                event.preventDefault();

                var $form = $(this);
                var formData = $form.serialize();

                showLoadingOverlay();

                $.ajax({
                    type: 'POST',
                    url: $form.attr('action'),
                    data: formData,
                    dataType: 'json',
                    success: function (response) {
                        var messageClass = response.status === 'success' ? 'alert-success' : 'alert-danger';
                        var message = response.message;

                        $('#message').html(`<div class="alert ${messageClass}" role="alert">${message}</div>`);
                    },
                    error: function () {
                        $('#message').html('<div class="alert alert-danger" role="alert">An unexpected error occurred. Please try again later.</div>');
                    },
                    complete: function () {
                        hideLoadingOverlay();
                    }
                });
            });
            function loadSewaKendras(courtComplexId) {
                showLoadingOverlay();
                return $.get("dynamicForm", { action: "sewaKendras", id: courtComplexId }).always(function () {
                    hideLoadingOverlay();
                });
            }

            // On state change, load districts
            $("#state").change(function () {
                var stateId = $(this).val();
                loadDistricts(stateId).done(function (data) {
                    $("#district").html(data);
                    $("#courtComplex").html("<option value=''>Select Court Complex</option>");
                    $("#kendra").html("<option value=''>Select E-Sewa Kendra</option>");
                });
            });

            // On district change, load court complexes
            $("#district").change(function () {
                var districtId = $(this).val();
                loadCourtComplexes(districtId).done(function (data) {
                    $("#courtComplex").html(data);
                    $("#kendra").html("<option value=''>Select E-Sewa Kendra</option>");
                });
            });

            // On court complex change, load e-Sewa Kendras
            $("#courtComplex").change(function () {
                var courtComplexId = $(this).val();
                loadSewaKendras(courtComplexId).done(function (data) {
                    $("#kendra").html(data);
                });
            });

            // Function to populate the form
            function populateForm(data) {
                var stateId = data.bookingDetails.stateId;
                var districtId = data.bookingDetails.districtId;
                var courtComplexId = data.bookingDetails.courtComplexId;
                var kendraId = data.bookingDetails.kendraId;
                var serviceId = data.bookingDetails.serviceId;
                $('#tokenNumber').val(data.bookingDetails.tokenNumber);
                $('#bookingId').val(data.bookingDetails.id);
                // Set state value and trigger change
                $('#state').val(stateId).trigger('change');

                // Load districts based on state
                loadDistricts(stateId).done(function (districtsData) {
                    $('#district').val(districtId).trigger('change');

                    // Load court complexes based on district
                    loadCourtComplexes(districtId).done(function (courtComplexesData) {
                        $('#courtComplex').val(courtComplexId).trigger('change');

                        // Load e-Sewa Kendras based on court complex
                        loadSewaKendras(courtComplexId).done(function (sewaKendrasData) {
                            $('#kendra').val(kendraId);

                            // Set service type if needed
                            serviceTypeChange(data.serviceTableDetails.ServiceDetails);
                            $('#serviceType').val(serviceId).trigger('change');
                        });
                    });
                });

                $('#advocateName').val(data.bookingDetails.advocateName);
                $('#enrollmentNumber').val(data.bookingDetails.enrollmentNumber);
                $('#phoneNumber').val(data.bookingDetails.phoneNumber);
                $('#email').val(data.bookingDetails.email);
                // Assuming data.bookingDetails.date is in the format "Aug 30, 2024"
                var bookingDate = new Date(data.bookingDetails.date);
                var formattedDate = (bookingDate.getMonth() + 1) + '/' + bookingDate.getDate() + '/' + bookingDate.getFullYear();

                $('#date').val(formattedDate);
                $('#time_slot').val(data.bookingDetails.timeSlot);

                if (data.bookingDetails.isAdvocate) {
                    $('#advocate').prop('checked', true);
                    $('#advocateDetails').show();
                } else {
                    $('#party').prop('checked', true);
                    $('#advocateDetails').hide();
                }
            }
            function serviceTypeChange(data) {
                $('#serviceType').change(function () {
                    const serviceId = $(this).val();
                    if (serviceId) {
                        loadServiceForm(serviceId, data);
                    } else {
                        $('#serviceFormContainer').empty();
                    }
                });
            }
            $('#esewa').hide();
            $('#modifyButton').on('click', function () {
                var tokenNumber = $('#token').val().trim();
                if (tokenNumber) {
                    showLoadingOverlay();
                    $('#modifyButton').prop('disabled', true);

                    $.ajax({
                        type: 'GET',
                        url: 'GetBookingDetailsServlet',
                        data: { token: tokenNumber },
                        dataType: 'json',
                        success: function (response) {
                            if (response.status === 'success') {
                                $('#esewa').show();
                                populateForm(response.data);
                            } else {
                                $('#responseMessage').html(`<div class="alert alert-danger" role="alert">${response.message}</div>`);
                            }
                        },
                        error: function () {
                            $('#responseMessage').html('<div class="alert alert-danger" role="alert">An unexpected error occurred. Please try again later.</div>');
                        },
                        complete: function () {
                            hideLoadingOverlay();
                            $('#modifyButton').prop('disabled', false);
                        }
                    });
                } else {
                    $('#responseMessage').html('<div class="alert alert-warning" role="alert">Please enter a token number.</div>');
                }
            });

            function loadServiceForm(serviceId, data) {
                // showLoadingOverlay();
                var servicedetails = encodeURIComponent(JSON.stringify(data));
                fetch(`getServices?serviceId=${serviceId}&servicedetails=${servicedetails}`)
                    .then((response) => response.text())
                    .then((html) => {
                        document.getElementById("serviceFormContainer").innerHTML = html;
                        hideLoadingOverlay();

                        flatpickr(".date-picker", {
                            minDate: "today",
                            maxDate: "today",
                            defaultDate: "today"
                        });

                        // Handling case_type change event for dynamic options
                        if ($('#case_type').length !== 0) {
                            $('div#civil_or_criminal, div#cnr_number').hide();
                            $('#case_type').change(function () {
                                handleCaseTypeChange($(this).val());
                            });
                        }
                    })
                    .catch((error) =>
                        console.error("Error loading service form:", error)
                    )
                    .finally(() => hideLoadingOverlay());
            }

            function loadHTML(url, elementId) {
                fetch(url)
                    .then((response) => response.text())
                    .then((data) => {
                        document.getElementById(elementId).innerHTML = data;
                    });
            }

            loadHTML("header.html", "header-placeholder");
            loadHTML("footer.html", "footer-placeholder");

            $('#generateTokenForm').on('submit', function (event) {
                event.preventDefault();

                var $form = $(this);
                var formData = $form.serialize();

                $('.loading-spinner').show();
                $('#generateTokenForm button').prop('disabled', true);

                $.ajax({
                    type: 'POST',
                    url: $form.attr('action'),
                    data: formData,
                    dataType: 'json',
                    success: function (response) {
                        var messageClass = response.status === 'success' ? 'alert-success' : 'alert-danger';
                        var message = response.message;

                        $('#responseMessage').html(`<div class="alert ${messageClass}" role="alert">${message}</div>`);
                    },
                    error: function (xhr, status, error) {
                        $('#responseMessage').html('<div class="alert alert-danger" role="alert">An unexpected error occurred. Please try again later.</div>');
                    },
                    complete: function () {
                        $('.loading-spinner').hide();
                        $('#generateTokenForm button').prop('disabled', false);
                    }
                });
            });

        });
    </script>
</body>

</html>