<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>e-Sewa Kendra-Service Booking</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <style>
    /* CSS for the loading overlay */
    @keyframes zoom {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.5);
      }

      100% {
        transform: scale(1);
      }
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      text-align: center;
      z-index: 9999;
      display: none;
      /* Hidden by default */
      display: flex;
      /* Ensure the spinner is centered */
      align-items: center;
      /* Vertically center */
      justify-content: center;
      /* Horizontally center */
    }

    .loading-overlay .spinner {
      font-size: 2rem;
      /* Adjust size as needed */
      animation: zoom 1.5s ease-in-out infinite;
      /* Apply zoom animation */
    }

    .required:after {
      content: "*";
      color: red;
      margin-left: 5px;
    }
  </style>

  <script>

    $(document).ready(function () {
      var isAvailable = false;

      function showLoadingOverlay() {
        $(".loading-overlay").show();
      }

      function hideLoadingOverlay() {
        $(".loading-overlay").hide();
      }
      function loadHTML(url, elementId) {
        fetch(url)
          .then((response) => response.text())
          .then((data) => {
            document.getElementById(elementId).innerHTML = data;
          });
      }

      loadHTML("header.html", "header-placeholder");
      loadHTML("footer.html", "footer-placeholder");
      function checkAvailability() {
        var serviceId = $("#serviceType").val();
        var date = $("#date").val();
        var timeSlot = $("#time_slot").val();
        var kendraId = $("#kendra").val();
        var courtComplexId = $("#courtComplex").val();

        if (serviceId && date && timeSlot && kendraId && courtComplexId) {
          showLoadingOverlay();
          $.get("checkAvailability", {
            serviceId: serviceId,
            date: date,
            timeSlot: timeSlot,
            kendraId: kendraId,
            courtComplexId: courtComplexId
          })
            .done(function (data) {
              try {
                var response = data;
                if (response.available) {
                  alert("Slots available at the selected E-Sewa Kendra!");
                  isAvailable = true;
                } else {
                  alert("No slots available at the selected E-Sewa Kendra.");
                  if (response.suggestions.length > 0) {
                    var suggestions = response.suggestions.map(function (kendra) {
                      return kendra.name;
                    }).join(', ');
                    alert("Available E-Sewa Kendras: " + suggestions);
                  } else {
                    alert("No other E-Sewa Kendras available for the selected time slot and date.");
                  }
                  isAvailable = false;
                }
              } catch (e) {
                console.error("Failed to parse JSON response:", e);
                alert("An error occurred while checking availability.");
              }
            })
            .fail(function (jqXHR, textStatus, errorThrown) {
              console.error("Failed to check availability:", textStatus, errorThrown);
              alert("An error occurred while checking availability.");
              isAvailable = false;
            })
            .always(function () {
              hideLoadingOverlay();
            });
        } else {
          alert("Please provide all required details.");
        }
      }


      function loadDynamicOptions(action, targetId, parentId, clearTargets) {
        var parentIdValue = parentId ? $(parentId).val() : null;
        showLoadingOverlay();
        $.get("dynamicForm", { action: action, id: parentIdValue })
          .done(function (data) {
            $(targetId).html(data);
            if (clearTargets) {
              clearTargets.forEach(function (target) {
                $(target).html("<option value=''>Select Option</option>");
              });
            }
          })
          .fail(function (jqXHR, textStatus, errorThrown) {
            console.error(
              "Failed to load dynamic options:",
              textStatus,
              errorThrown
            );
          })
          .always(function () {
            hideLoadingOverlay();
          });
      }

      $("#state").change(function () {
        loadDynamicOptions("districts", "#district", "#state", [
          "#courtComplex",
          "#kendra",
        ]);
      });

      $("#district").change(function () {
        loadDynamicOptions("courtComplexes", "#courtComplex", "#district", [
          "#kendra",
        ]);
      });

      $("#courtComplex").change(function () {
        loadDynamicOptions("sewaKendras", "#kendra", "#courtComplex");
      });

      $("#serviceType").change(function () {
        var serviceId = $(this).val();
        if (serviceId) {
          showLoadingOverlay();
          fetch(`getServices?serviceId=${serviceId}`)
            .then((response) => response.text())
            .then((html) => {
              document.getElementById("serviceFormContainer").innerHTML =
                html;
              $("#date, #time_slot").change(function () {
                checkAvailability();
              });

              flatpickr(".date-Picker", {
                minDate: "today",
                maxDate: "today",
                defaultDate: "today"
              });
              // Check if #case_type element exists and bind the change event
              if ($('#case_type').length != 0) {
                $('div#civil_or_criminal,div#cnr_number').hide();
                $('#case_type').change(function () {
                  handleCaseTypeChange($(this).val());
                });
              }
            })
            .catch((error) =>
              console.error("Error loading service form:", error)
            )
            .finally(() => hideLoadingOverlay());
        } else {
          $("#serviceFormContainer").empty();
        }
      });


      function handleCaseTypeChange(value) {
        if (value === '1') {
          $('div#civil_or_criminal').show();
          $('div#cnr_number').hide();
        } else if (value === '0') {
          $('div#civil_or_criminal').hide();
          $('div#cnr_number').show();
        } else {
          $('div#civil_or_criminal').hide();
          $('div#cnr_number').hide();
        }
      }


      // Show loading overlay on page load
      $(".loading-overlay").show();

      // Function to show loading overlay
      function showLoadingOverlay() {
        $(".loading-overlay").show();
      }

      // Function to hide loading overlay
      function hideLoadingOverlay() {
        $(".loading-overlay").hide();
      }

      // Load states
      $.get("dynamicForm", { action: "states" }, function (data) {
        $("#state").html(data);
      }).always(function () {
        hideLoadingOverlay();
      });

      // On state change, load districts
      $("#state").change(function () {
        var stateId = $(this).val();
        showLoadingOverlay();
        $.get(
          "dynamicForm",
          { action: "districts", id: stateId },
          function (data) {
            $("#district").html(data);
            $("#courtComplex").html(
              "<option value=''>Select Court Complex</option>"
            );
            $("#kendra").html(
              "<option value=''>Select E-Sewa Kendra</option>"
            );
          }
        ).always(function () {
          hideLoadingOverlay();
        });
      });

      // On district change, load court complexes
      $("#district").change(function () {
        var districtId = $(this).val();
        showLoadingOverlay();
        $.get(
          "dynamicForm",
          { action: "courtComplexes", id: districtId },
          function (data) {
            $("#courtComplex").html(data);
            $("#kendra").html(
              "<option value=''>Select E-Sewa Kendra</option>"
            );
          }
        ).always(function () {
          hideLoadingOverlay();
        });
      });

      // On court complex change, load e-Sewa Kendras
      $("#courtComplex").change(function () {
        var courtComplexId = $(this).val();
        showLoadingOverlay();
        $.get(
          "dynamicForm",
          { action: "sewaKendras", id: courtComplexId },
          function (data) {
            $("#kendra").html(data);
          }
        ).always(function () {
          hideLoadingOverlay();
        });
      });

      // Load service types on page load
      $.get("dynamicForm", { action: "serviceTypes" }, function (data) {
        $("#serviceType").html(data);
      }).always(function () {
        hideLoadingOverlay();
      });

      function loadServiceForm(serviceId) {
        $(".loading-overlay").show();
        fetch(`getServices?serviceId=${serviceId}`)
          .then((response) => response.text())
          .then((html) => {
            document.getElementById("serviceFormContainer").innerHTML = html;
            $(".loading-overlay").hide();
          });
        flatpickr("#date", {
          minDate: "today",
          maxDate: new Date().fp_incr(1),
        });
      }

      function showError(message) {
        $("#error-message").text(message).show();
      }

      function hideError() {
        $("#error-message").hide();
      }

      function validateForm() {
        var isValid = true;
        var errors = [];

        // Clear previous errors
        hideError();

        // Example validation
        var advocateName = $("#advocateName").val();
        if (advocateName.length < 2 || advocateName.length > 100) {
          isValid = false;
          errors.push("Advocate Name must be between 2 and 100 characters.");
        }

        var phoneNumber = $("#phoneNumber").val();
        var phoneRegex = /^[0-9]{10}$/;
        if (!phoneRegex.test(phoneNumber)) {
          isValid = false;
          errors.push("Phone Number must be 10 digits.");
        }

        var email = $("#email").val();
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (email != '' && !emailRegex.test(email)) {
          isValid = false;
          errors.push("Email Address is not valid.");
        }

        // Validate that dropdowns are not default
        var state = $("#state").val();
        if (state === "") {
          isValid = false;
          errors.push("Please select a State.");
        }

        var district = $("#district").val();
        if (district === "") {
          isValid = false;
          errors.push("Please select a District.");
        }

        var courtComplex = $("#courtComplex").val();
        if (courtComplex === "") {
          isValid = false;
          errors.push("Please select a Court Complex.");
        }

        var kendra = $("#kendra").val();
        if (kendra === "") {
          isValid = false;
          errors.push("Please select an e-Sewa Kendra.");
        }

        var serviceType = $("#serviceType").val();
        if (serviceType === "") {
          isValid = false;
          errors.push("Please select a Service Type.");
        }
        if (!isValid || !isAvailable) {
          showError(errors.join("\n"));
        }

        return isValid;
      }

      $("form").on("submit", function (event) {
        if (!validateForm()) {
          event.preventDefault(); // Prevent form submission
        }
      });
    });
    // window.onload = function () {
    //   var errorMessage = '<%= request.getAttribute("errorMessage") %>';
    //   if (errorMessage) {
    //     document.getElementById("error-message").style.display = "block";
    //     document.getElementById("error-text").innerText = errorMessage;
    //   }
    // };
  </script>
</head>

<body>
  <div id="header-placeholder"></div>
  <div class="loading-overlay">
    <div class="spinner">
      <i class="fa fa-spinner fa-spin"></i>
    </div>
  </div>
  <div class="container mt-5">
    <h1 class="mb-4">Book e-Sewa Kendra</h1>
    <div id="error-message">
      <span id="error-text"></span>
    </div>
    <form id="registrationForm" method="post" action="bookService">
      <div class="form-row mb-3">
        <div class="col-md-3">
          <label for="state" class="required">State:</label>
          <select name="state" id="state" class="form-control">
            <option value="">Select State</option>
          </select>
        </div>
        <br />
        <div class="col-md-3">
          <label for="district" class="required">District:</label>
          <select name="district" id="district" class="form-control">
            <option value="">Select District</option>
          </select>
        </div>
        <br />
        <div class="col-md-3">
          <label for="courtComplex" class="required">Court Complex:</label>
          <select name="courtComplex" id="courtComplex" class="form-control">
            <option value="">Select Court Complex</option>
          </select>
        </div>
        <br />
        <div class="col-md-3">
          <label for="kendra" class="required">SewaKendra:</label>
          <select name="kendra" id="kendra" class="form-control">
            <option value="">Select E-Sewa Kendra</option>
          </select>
        </div>
      </div>
      <br />
      <div class="form-row mb-3">
        <div class="col-md-4">
          <label for="serviceType" class="required">Service Type:</label>
        </div>
        <div class="col-md-8">
          <select name="serviceType" id="serviceType" class="form-control" onchange="loadServiceForm(this.value)">
            <option value="">Select Type of Service</option>
          </select>
        </div>
      </div>
      <br />
      <div class="form-row mb-3">
        <div class="col-md-4">
          <label for="advocateName" class="required">Advocate Name/Party in Person:</label>
        </div>
        <div class="col-md-8">
          <input type="text" name="advocateName" id="advocateName" class="form-control"
            placeholder="Enter Advocate Name/Party in Person Name" required />
        </div>
      </div>
      <br />
      <div class="form-row mb-3">
        <div class="col-md-4">
          <label for="enrollmentNumber">Enrollment Number:[MS/XXXX/YYYY]</label>
        </div>
        <div class="col-md-8">
          <input type="text" name="enrollmentNumber" id="enrollmentNumber" class="form-control"
            placeholder="State Code/Bar Code/Bar Year" />
        </div>
      </div>
      <br />
      <div class="form-row mb-3">
        <div class="col-md-4">
          <label for="phoneNumber" class="required">Phone Number:</label>
        </div>
        <div class="col-md-8">
          <input type="text" name="phoneNumber" id="phoneNumber" class="form-control"
            placeholder="Enter 10 digit Phone number" required />
        </div>
      </div>
      <br />
      <div class="form-row mb-3">
        <div class="col-md-4">
          <label for="email" class="required">Email:</label>
        </div>
        <div class="col-md-8">
          <input type="email" name="email" id="email" placeholder="Enter Email id" class="form-control" required />
        </div>
      </div>
      <br />
      <div id="serviceFormContainer">
        <!-- Dynamic service-specific form will be loaded here -->
      </div>
      <div id="registrationMessage" class="mt-4"></div>
      <button type="submit" class="btn btn-primary">Generate Token</button>
    </form>

    <div class="modal fade" id="pdfModal" tabindex="-1" role="dialog" aria-labelledby="pdfModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pdfModalLabel">PDF Document</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="pdfLoader" class="text-center">
              <div class="spinner-border" role="status">
                <span class="sr-only">Loading...</span>
              </div>
            </div>
            <iframe id="pdfFrame" src="" style="width: 100%; height: 600px; display: none;" frameborder="0"></iframe>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="footer-placeholder"></div>
</body>

</html>